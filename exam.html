<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم — المشرف</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #1e88e5; --brand-dark: #1565c0; --brand-light: #e3f2fd;
      --bg: #f4f7f9; --card-bg: #ffffff; --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      --ink: #0f172a; --muted: #6b7280; --border-color: #e5e7eb;
      --error: #ef4444; --error-dark: #dc2626; --success: #22c55e;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    body { margin: 0; font-family: "Tajawal", sans-serif; background-color: var(--bg); color: var(--ink); line-height: 1.6; }
    .container { width: min(1200px, 94%); margin: 20px auto; padding: 20px 0; }
    
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 1001; }
    .login-box { background: var(--card-bg); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,.1); width: min(380px, 90%); border-top: 5px solid var(--brand); animation: modal-fade-in 0.5s ease; }
    .login-box img { max-width: 80px; margin-bottom: 20px; }
    .login-box h2 { font-size: 1.8em; color: var(--ink); margin: 0 0 10px; }
    .login-box p { color: var(--muted); margin-top: 0; margin-bottom: 25px; }
    .login-box input { text-align: center; font-size: 16px; padding: 15px; margin-bottom: 15px; letter-spacing: 2px; }
    .login-box button { width: 100%; font-size: 18px; padding: 15px; }

    .site-header { text-align: center; margin-bottom: 30px; }
    .site-header .logo { max-width: 90px; height: auto; margin-bottom: 15px; }
    .site-header h1 { font-weight: 800; color: var(--brand-dark); margin: 0 0 5px 0; font-size: 2.2em; }
    .site-header h2 { font-weight: 700; color: var(--ink); margin: 0; font-size: 1.3em; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    .page-header h1, .page-header h2 { margin: 0; font-size: 2em; color: var(--ink); }
    .card { background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
    .credit { text-align: center; color: #6b7280; font-size: 14px; margin-top: 40px;}
    
    #exams-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px; }
    .exam-card { padding: 0; border-top: 4px solid var(--brand); }
    .exam-card .card-content { padding: 20px 25px; flex-grow: 1; }
    .exam-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .exam-card .card-header h3 { margin: 0; font-size: 1.15em; color: var(--brand-dark); line-height: 1.4; }
    .exam-card .card-meta { font-size: 0.85em; color: var(--muted); margin: 8px 0; }
    .exam-card .card-actions { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background-color: #fafafa; border-top: 1px solid var(--border-color); }
    .exam-card .action-group { display: flex; gap: 10px; }
    
    #submissions-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; }
    .submission-card { flex-direction: row; align-items: center; justify-content: space-between; padding: 20px; border-left: 5px solid var(--muted); }
    .student-profile { display: flex; align-items: center; gap: 15px; text-align: right; }
    .student-profile img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .student-profile .info h3 { margin: 0 0 4px 0; font-size: 1.1em; color: var(--ink); }
    .student-profile .info p { margin: 0; color: var(--muted); font-size: 0.9em; }
    
    input, textarea, label { display: block; width: 100%; padding: 14px; margin-bottom: 12px; border: 1.5px solid var(--border-color); border-radius: 14px; font-family: inherit; font-size: 15px; }
    button, .btn-as-link { background: var(--brand); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
    button:hover, .btn-as-link:hover { background: var(--brand-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #show-create-exam-modal-btn { padding: 12px 24px; font-size: 16px; }
    button:disabled { background: #ccc !important; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; }
    .btn-secondary { background: #6c757d; } .btn-secondary:hover { background: #5a6268; }
    .btn-danger { background: var(--error); } .btn-danger:hover { background: var(--error-dark); }
    .loader { width: 18px; height: 18px; border: 2.5px solid rgba(255,255,255,0.5); border-top-color: #FFF; border-radius: 50%; display: inline-block; animation: rotation 0.8s linear infinite; }
    @keyframes rotation { to { transform: rotate(360deg); } }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(8px); }
    .modal-content { background: #fff; padding: 30px; border-radius: 20px; width: min(650px, 92%); max-height: 90vh; overflow-y: auto; animation: modal-fade-in 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
    .close-btn { font-size: 28px; line-height: 1; border: none; background: none; cursor: pointer; }
    .question-block { border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; margin-top: 15px; background: #fafafa; }
    #delete-confirm-modal .modal-content { width: min(450px, 90%); }
    #delete-confirm-modal .modal-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input[type="checkbox"]:checked + .slider { background-color: var(--success); }
    input[type="checkbox"]:checked + .slider:before { transform: translateX(22px); }
    .status-text { font-weight: bold; font-size: 14px; }
    .status-text.active { color: var(--success); }
    .status-text.inactive { color: var(--muted); }
    .timer-options { border: 1px solid var(--border-color); border-radius: 14px; padding: 15px; margin-bottom: 20px; }
    .timer-options label { display: inline-flex; align-items: center; gap: 8px; width: auto; margin-bottom: 0; font-weight: normal; font-size: 15px; }
    input[type="radio"] { width: auto; }
    .notification { padding: 15px; border-radius: 12px; color: #fff; text-align: center; margin-bottom: 15px; display: none; animation: modal-fade-in 0.3s; }
    .notification.success { background-color: var(--success); }
    .notification.error { background-color: var(--error); }
    .view-wrapper { position: relative; }
    .view { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
    .view.hidden { opacity: 0; transform: translateX(-20px); pointer-events: none; position: absolute; width: 100%; top: 0; }
    .card, .submission-card { opacity: 0; animation: card-fade-in 0.5s ease-out forwards; }
    @keyframes card-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 850px) {
      #exams-list-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="tbok.png" alt="شعار جامعة تبوك">
            <h2>لوحة التحكم</h2>
            <p>الرجاء إدخال كلمة المرور للوصول</p>
            <input type="password" id="password-input" placeholder="••••••••">
            <button id="login-btn">دخول</button>
        </div>
    </div>

    <div id="admin-content" style="display: none;" class="container">
        <header class="site-header">
            <img src="tbok.png" alt="شعار جامعة تبوك" class="logo">
            <h1>جامعة تبوك</h1>
            <h2>لوحة تحكم كوادر السلامة والصحة المهنية</h2>
        </header>
        <main class="view-wrapper">
            <div id="exams-view" class="view">
                <div class="page-header"><h1>الاختبارات المنشأة</h1><button id="show-create-exam-modal-btn">+ إنشاء اختبار جديد</button></div>
                <div id="exams-list-container"></div>
            </div>
            <div id="submissions-view" class="view hidden">
                <div class="page-header"><h2 id="submissions-title"></h2><button id="back-to-exams-btn" class="btn-secondary">&larr; العودة</button></div>
                <div id="submissions-list-container"></div>
            </div>
        </main>
        <footer class="credit"><p>اعداد/المهندس خالد الغامدي</p></footer>
    </div>

    <div id="create-exam-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>إنشاء اختبار جديد</h3><button class="close-btn" data-modal-id="create-exam-modal">&times;</button></div>
            <div id="notification-area"></div>
            <label for="exam-title">عنوان الاختبار</label><input type="text" id="exam-title" placeholder="مثال: اختبار السلامة المهنية - الأسبوع الأول">
            <div class="timer-options">
                <label style="font-weight: bold; margin-bottom: 10px; width: 100%;">نظام التوقيت:</label>
                <div><label><input type="radio" name="timerMode" value="individual" checked> وقت منفصل لكل سؤال</label><label style="margin-right: 20px;"><input type="radio" name="timerMode" value="total"> وقت إجمالي للاختبار</label></div>
                <div id="total-duration-container" style="display: none;"><label for="total-duration">المدة الإجمالية للاختبار (بالدقائق)</label><input type="number" id="total-duration" placeholder="مثال: 30"></div>
            </div>
            <div id="questions-container"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;"><button id="add-question-btn" class="btn-secondary">إضافة سؤال</button><button id="remove-question-btn" class="btn-danger" style="display: none;">حذف آخر سؤال</button></div>
            <hr style="border:0; border-top: 1px solid var(--border-color); margin: 25px 0;">
            <button id="save-exam-btn" style="width: 100%;">حفظ الاختبار</button>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>تأكيد الحذف</h3></div>
            <p id="delete-confirm-text" style="font-size: 1.1em; line-height: 1.7;">هل أنت متأكد من رغبتك في حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="modal-actions">
                <button id="cancel-delete-btn" class="btn-secondary">إلغاء</button>
                <button id="confirm-delete-btn" class="btn-danger">نعم، قم بالحذف</button>
            </div>
        </div>
    </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = { apiKey: "AIzaSyAFIa5WAPy8Vn9p4T4Ak3yCly3_9bwsMZU", authDomain: "database-506.firebaseapp.com", projectId: "database-506", storageBucket: "database-506.firebasestorage.app", messagingSenderId: "926446561022", appId: "1:926446561022:web:9e57f6fd1fdc3a2f58a7af" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const BASE_URL = "https://tabukexnes.netlify.app";

    const loginOverlay = document.getElementById('login-overlay');
    const adminContent = document.getElementById('admin-content');
    const loginBtn = document.getElementById('login-btn');
    const passwordInput = document.getElementById('password-input');
    const correctPassword = "KHLEDADMIN";

    function handleLogin() {
        if (passwordInput.value === correctPassword) {
            sessionStorage.setItem('adminLoggedIn', 'true');
            checkLogin();
        } else {
            alert('كلمة المرور غير صحيحة');
        }
    }

    function checkLogin() {
      if (sessionStorage.getItem('adminLoggedIn') === 'true') {
        loginOverlay.style.display = 'none';
        adminContent.style.display = 'block';
        loadExams();
      } else {
        loginOverlay.style.display = 'flex';
      }
    }
    
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

    const examsView = document.getElementById('exams-view');
    const submissionsView = document.getElementById('submissions-view');
    const examsListContainer = document.getElementById('exams-list-container');
    const submissionsListContainer = document.getElementById('submissions-list-container');
    const backToExamsBtn = document.getElementById('back-to-exams-btn');
    const submissionsTitle = document.getElementById('submissions-title');
    const createExamModal = document.getElementById('create-exam-modal');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const examTitleInput = document.getElementById('exam-title');
    const questionsContainer = document.getElementById('questions-container');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const removeQuestionBtn = document.getElementById('remove-question-btn');
    const saveExamBtn = document.getElementById('save-exam-btn');
    const notificationArea = document.getElementById('notification-area');
    const timerModeRadios = document.querySelectorAll('input[name="timerMode"]');
    const totalDurationContainer = document.getElementById('total-duration-container');
    let questionCount = 0;
    let itemToDelete = null;

    document.getElementById('show-create-exam-modal-btn').addEventListener('click', () => createExamModal.style.display = 'flex');
    document.querySelector('#create-exam-modal .close-btn').addEventListener('click', () => createExamModal.style.display = 'none');

    timerModeRadios.forEach(radio => { radio.addEventListener('change', (e) => { const isTotalMode = e.target.value === 'total'; totalDurationContainer.style.display = isTotalMode ? 'block' : 'none'; document.querySelectorAll('.duration-input-container').forEach(c => { c.style.display = isTotalMode ? 'none' : 'block'; }); }); });
    const showNotification = (message, type) => { const notif = Object.assign(document.createElement('div'), { className: `notification ${type}`, textContent: message }); notificationArea.innerHTML = ''; notificationArea.appendChild(notif); notif.style.display = 'block'; setTimeout(() => { notif.style.display = 'none'; }, 4000); };
    const updateButtons = () => { removeQuestionBtn.style.display = (questionCount > 0) ? 'inline-block' : 'none'; };
    
    addQuestionBtn.addEventListener('click', () => {
        questionCount++;
        const block = document.createElement('div');
        block.className = 'question-block';
        block.id = `q-block-${questionCount}`;
        block.innerHTML = `<h4>السؤال ${questionCount}</h4><textarea name="q-text" rows="3" placeholder="نص السؤال"></textarea><div style="display:flex; gap:15px;"><div class="duration-input-container"><label>المدة (دقائق)</label><input type="number" name="q-duration" placeholder="e.g., 7"></div><div><label>الكلمات</label><input type="number" name="q-wordcount" placeholder="e.g., 200"></div></div>`;
        const isTotalMode = document.querySelector('input[name="timerMode"]:checked').value === 'total';
        block.querySelector('.duration-input-container').style.display = isTotalMode ? 'none' : 'block';
        questionsContainer.appendChild(block);
        updateButtons();
    });
    
    removeQuestionBtn.addEventListener('click', () => { if (questionCount <= 0) return; document.getElementById(`q-block-${questionCount}`).remove(); questionCount--; updateButtons(); });
    
    saveExamBtn.addEventListener('click', async () => {
        const title = examTitleInput.value.trim();
        if (!title) { showNotification('خطأ: الرجاء إدخال عنوان للاختبار.', 'error'); return; }
        const timerMode = document.querySelector('input[name="timerMode"]:checked').value;
        const totalDuration = parseInt(document.getElementById('total-duration').value, 10);
        if (timerMode === 'total' && (isNaN(totalDuration) || totalDuration <= 0)) { showNotification('خطأ: الرجاء إدخال مدة إجمالية صحيحة للاختبار.', 'error'); return; }
        const questions = [];
        let isValid = true;
        questionsContainer.querySelectorAll('.question-block').forEach(b => {
            const text = b.querySelector('[name="q-text"]').value.trim();
            const wordCount = parseInt(b.querySelector('[name="q-wordcount"]').value, 10);
            const questionData = { text, wordCount };
            if (timerMode === 'individual') { const duration = parseInt(b.querySelector('[name="q-duration"]').value, 10); if (isNaN(duration) || duration <= 0) isValid = false; questionData.duration = duration; }
            if (!text || isNaN(wordCount) || wordCount <= 0) isValid = false;
            questions.push(questionData);
        });
        if (questions.length === 0) { showNotification('خطأ: يجب إضافة سؤال واحد على الأقل للاختبار.', 'error'); return; }
        if (!isValid) { showNotification('خطأ: الرجاء تعبئة جميع حقول الأسئلة بشكل صحيح.', 'error'); return; }
        
        saveExamBtn.disabled = true;
        saveExamBtn.innerHTML = '<span class="loader"></span> حفظ...';
        try {
            const examData = { title, questions, timerMode, isActive: false, createdAt: serverTimestamp() };
            if (timerMode === 'total') { examData.totalDuration = totalDuration; }
            await addDoc(collection(db, "Exams"), examData);
            examTitleInput.value = ''; questionsContainer.innerHTML = ''; questionCount = 0;
            updateButtons(); createExamModal.style.display = 'none'; loadExams();
        } catch (error) { showNotification('حدث خطأ أثناء الحفظ في قاعدة البيانات.', 'error'); console.error(error); } 
        finally { saveExamBtn.disabled = false; saveExamBtn.textContent = 'حفظ الاختبار'; }
    });

    async function loadExams() {
        examsListContainer.innerHTML = '<div class="card" style="grid-column: 1 / -1; text-align:center;"><p>جاري تحميل الاختبارات...</p></div>';
        try {
            const q = query(collection(db, "Exams"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            examsListContainer.innerHTML = querySnapshot.empty ? '<div class="card" style="grid-column: 1 / -1;"><p>لم يتم إنشاء أي اختبارات بعد. اضغط على "+ إنشاء اختبار جديد" للبدء.</p></div>' : '';
            querySnapshot.forEach((doc, index) => {
                const exam = doc.data(); const examId = doc.id;
                const card = document.createElement('div'); card.className = 'card exam-card';
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `<div class="card-content"><div class="card-header"><h3>${exam.title}</h3><div class="status-control"><span class="status-text ${exam.isActive ? 'active' : 'inactive'}">${exam.isActive ? 'فعال' : 'موقوف'}</span><label class="toggle-switch"><input type="checkbox" class="toggle-status-btn" data-exam-id="${examId}" ${exam.isActive ? 'checked' : ''}><span class="slider"></span></label></div></div><p class="card-meta">(${exam.questions.length} أسئلة) &bull; ${new Date(exam.createdAt?.toDate()).toLocaleDateString('ar-SA')}</p></div><div class="card-actions"><div class="action-group"><button class="copy-link-btn" data-link="${BASE_URL}/exam.html?id=${examId}">نسخ</button><button class="view-submissions-btn" data-exam-id="${examId}" data-exam-title="${exam.title}">الإجابات</button></div><button class="delete-exam-btn btn-icon" data-exam-id="${examId}" title="حذف الاختبار"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--muted);"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg></button></div>`;
                examsListContainer.appendChild(card);
            });
        } catch (error) { console.error("Error loading exams:", error); examsListContainer.innerHTML = '<div class="card" style="border-color: var(--error);"><p>حدث خطأ في تحميل الاختبارات.</p></div>'; }
    }
    
    async function loadSubmissions(examId, examTitle) {
        submissionsTitle.textContent = `إجابات اختبار: ${examTitle}`;
        submissionsListContainer.innerHTML = '<div class="card" style="text-align:center;"><p>جاري تحميل الإجابات...</p></div>';
        try {
            const q = query(collection(db, "Submissions"), where("examId", "==", examId), orderBy("submissionTime", "desc"));
            const querySnapshot = await getDocs(q);
            submissionsListContainer.innerHTML = querySnapshot.empty ? '<div class="card" style="grid-column: 1 / -1; text-align:center;"><p>لا توجد أي إجابات لهذا الاختبار حتى الآن.</p></div>' : '';
            querySnapshot.forEach((doc, index) => {
                const sub = doc.data(); const subId = doc.id; const studentName = sub.name || "طالب غير معروف"; const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(studentName.charAt(0))}&background=random&color=fff&size=50`;
                const card = document.createElement('div'); card.className = 'card submission-card';
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `<div class="student-profile"><img src="${avatarUrl}" alt="Avatar"><div class="info"><h3>${studentName}</h3><p>رقم الهوية: ${sub.idNumber || 'غير متوفر'}</p></div></div><a href="Exhibition.html?id=${subId}" class="btn-as-link details-btn">التفاصيل</a>`;
                submissionsListContainer.appendChild(card);
            });
        } catch (error) { console.error("Error loading submissions: ", error); submissionsListContainer.innerHTML = '<div class="card" style="border-color: var(--error);"><p style="color: var(--error);">حدث خطأ أثناء تحميل الإجابات. تأكد من أن الفهرس (Index) المطلوب تم إنشاؤه في Firestore.</p></div>'; }
    }

    async function handleToggleStatus(examId, newStatus, statusTextElement) { try { await updateDoc(doc(db, "Exams", examId), { isActive: newStatus }); statusTextElement.textContent = newStatus ? 'فعال' : 'موقوف'; statusTextElement.className = `status-text ${newStatus ? 'active' : 'inactive'}`; } catch (error) { console.error("Error updating status: ", error); alert("فشل تحديث حالة الاختبار."); const checkbox = document.querySelector(`.toggle-status-btn[data-exam-id="${examId}"]`); if(checkbox) checkbox.checked = !newStatus; } }
    
    function handleDeleteExam(examId) {
        itemToDelete = { id: examId, type: 'exam' };
        document.getElementById('delete-confirm-text').textContent = 'هل أنت متأكد من حذف هذا الاختبار؟ سيتم حذفه بشكل نهائي ولا يمكن التراجع عن هذا الإجراء.';
        deleteConfirmModal.style.display = 'flex';
    }

    async function executeDelete() {
        if (!itemToDelete) return;
        const { id, type } = itemToDelete;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.innerHTML = '<span class="loader"></span> جاري الحذف...';
        try {
            if (type === 'exam') { await deleteDoc(doc(db, "Exams", id)); loadExams(); }
            deleteConfirmModal.style.display = 'none';
        } catch (error) { console.error(`Error deleting ${type}:`, error); alert(`فشل حذف العنصر.`); } 
        finally { confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'نعم، قم بالحذف'; itemToDelete = null; }
    }
    
    confirmDeleteBtn.addEventListener('click', executeDelete);
    cancelDeleteBtn.addEventListener('click', () => { deleteConfirmModal.style.display = 'none'; itemToDelete = null; });

    examsListContainer.addEventListener('click', (e) => { const button = e.target.closest('button'); const toggle = e.target.closest('.toggle-status-btn'); if (button?.classList.contains('copy-link-btn')) { navigator.clipboard.writeText(button.dataset.link); button.textContent = 'تم النسخ!'; setTimeout(() => { button.textContent = 'نسخ'; }, 2000); } if (button?.classList.contains('view-submissions-btn')) { examsView.classList.add('hidden'); submissionsView.classList.remove('hidden'); loadSubmissions(button.dataset.examId, button.dataset.examTitle); } if (button?.classList.contains('delete-exam-btn')) { handleDeleteExam(button.dataset.examId); } if (toggle) { const statusText = toggle.closest('.status-control').querySelector('.status-text'); handleToggleStatus(toggle.dataset.examId, toggle.checked, statusText); } });
    
    backToExamsBtn.addEventListener('click', () => { submissionsView.classList.add('hidden'); examsView.classList.remove('hidden'); });
    
    checkLogin();
  </script>
</body>
</html>
