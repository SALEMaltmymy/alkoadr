<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>جامعة تبوك — اختبار كوادر السلامة والصحة المهنية</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #1e88e5; --brand-dark: #1565c0; --brand-light: #e3f2fd;
      --bg: #f4f7f9; --card-bg: #ffffff; --shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
      --ink: #0f172a; --muted: #6b7280; --border-color: #e5e7eb;
      --error: #ef4444; --success: #22c55e;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    body { margin: 0; font-family: "Tajawal", sans-serif; background-color: var(--bg); color: var(--ink); display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px 0; }
    .container { width: min(650px, 92%); margin: auto; }
    .site-header { text-align: center; margin-bottom: 25px; }
    .site-header .logo { max-width: 90px; height: auto; margin-bottom: 15px; }
    .site-header h1 { font-weight: 800; color: var(--brand-dark); margin: 0 0 5px 0; font-size: 2em; }
    .site-header h2 { font-weight: 700; color: var(--ink); margin: 0; font-size: 1.2em; }
    .supervisor { text-align: center; margin: -5px 0 25px; color: var(--muted); }
    .card { background: var(--card-bg); border-radius: 22px; padding: 30px 40px; box-shadow: var(--shadow); margin-top: 20px; transition: all .4s ease; animation: fade-slide-up .6s ease-out; }
    @keyframes fade-slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .step { display: none; }
    .step.active { display: block; animation: fade-slide-up 0.5s ease-out; }
    .progress-bar { background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 20px; height: 12px; }
    .progress { background: linear-gradient(135deg, var(--brand-dark), var(--brand)); height: 100%; width: 0%; transition: width 0.4s ease-in-out; }
    input, textarea { width: 100%; padding: 14px; margin: 12px 0; border: 1.5px solid #ddd; border-radius: 14px; font-family: inherit; font-size: 16px; transition: all .3s; }
    input:focus, textarea:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 4px rgba(30, 136, 229, 0.15); }
    button { background: var(--brand); color: #fff; border: none; padding: 14px 30px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; min-width: 140px; min-height: 50px; }
    button:hover { background: var(--brand-dark); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(30, 136, 229, 0.3); }
    .error { color: var(--error); font-size: 14px; margin-top: -8px; min-height: 20px; text-align: right; }
    .timer { font-size: 20px; font-weight: 700; color: var(--error); text-align: center; margin-bottom: 20px; background: #ffebee; padding: 10px; border-radius: 12px; }
    #total-timer-container { font-size: 20px; font-weight: 700; color: var(--error); text-align: center; margin-bottom: 20px; background: #ffebee; padding: 10px; border-radius: 12px; display: none; }
    .credit { text-align: center; color: #6b7280; font-size: 14px; margin-top: 30px; }
    .loader { width: 18px; height: 18px; border: 2.5px solid rgba(255,255,255,0.5); border-top-color: #FFF; border-radius: 50%; display: inline-block; animation: rotation 0.8s linear infinite; }
    @keyframes rotation { to { transform: rotate(360deg); } }
    #success-message { text-align: center; }
    #success-message .icon { font-size: 60px; color: var(--success); width: 90px; height: 90px; border-radius: 50%; background: #e8f5e9; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: icon-pop-in 0.5s ease-out; }
    @keyframes icon-pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .counter-wrapper { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; gap: 15px; }
    .counter-text { font-weight: bold; color: var(--brand-dark); white-space: nowrap; }
    .word-progress-bar { flex-grow: 1; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .word-progress-bar-inner { height: 100%; width: 0%; background-color: var(--brand); border-radius: 4px; transition: width 0.3s ease, background-color 0.3s ease; }
    .word-progress-bar-inner.completed { background-color: var(--success); }
    .step-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
    .btn-prev { background: var(--bg); color: var(--ink); border: 1px solid var(--border-color); }
    .btn-prev:hover { background-color: #e2e8f0; box-shadow: none; transform: none; }
    
    #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .toast { padding: 15px 25px; border-radius: 12px; color: white; font-weight: 500; box-shadow: 0 5px 20px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.4s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background-color: var(--error); }
    
    @media (max-width: 600px) {
        .card { padding: 20px; }
        .site-header h1 { font-size: 1.8em; }
        .site-header h2 { font-size: 1.1em; }
        button { padding: 12px 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <img src="tbok.png" alt="شعار جامعة تبوك" class="logo">
      <h1>جامعة تبوك</h1>
      <h2 id="exam-title-display">اختبار كوادر السلامة والصحة المهنية</h2>
      <p class="supervisor">المشرف: المهندس احمد الياقوت</p>
    </header>

    <div class="card" id="exam-card">
      <div id="loading-exam" style="text-align: center; padding: 40px 0;"><p>جاري تحميل الاختبار، يرجى الانتظار...</p></div>
      <div id="total-timer-container">الوقت الإجمالي المتبقي: <span id="total-timer-span">00:00</span></div>
      <div class="progress-bar" style="display: none;"><div class="progress" id="progress"></div></div>
      <form id="exam-form" style="display: none;">
        <div class="step" data-step="1">
          <h3>الخطوة 1: الاسم</h3><input type="text" id="name" placeholder="اكتب اسمك الكامل باللغة العربية" required><div class="error" id="err1"></div>
          <div class="step-actions" style="justify-content: center;"><button type="button" data-next="2">التالي</button></div>
        </div>
        <div class="step" data-step="2">
          <h3>الخطوة 2: رقم الهوية</h3><input type="text" id="idNumber" placeholder="أدخل رقم الهوية المكون من 10 أرقام" required maxlength="10"><div class="error" id="err2"></div>
          <div class="step-actions" style="justify-content: space-between;"><button type="button" class="btn-prev" data-prev="1">السابق</button><button type="button" data-next="3">التالي</button></div>
        </div>
        <div class="step" data-step="3">
          <h3>الخطوة 3: بيانات التواصل</h3><input type="tel" id="phone" placeholder="رقم الجوال (05XXXXXXXX)" required><input type="email" id="email" placeholder="البريد الإلكتروني" required><div class="error" id="err3"></div>
          <div class="step-actions" style="justify-content: space-between;"><button type="button" class="btn-prev" data-prev="2">السابق</button><button type="button" data-next="4">بدء الاختبار</button></div>
        </div>
      </form>
    </div>

    <div class="card" id="success-message" style="display: none;">
        <div class="icon">&#10004;</div><h2 style="color: var(--success-color);">تم الإرسال بنجاح!</h2><p>شكرًا لك على إتمام الاختبار. سيتم مراجعة إجابتك والتواصل معك قريبًا.</p>
    </div>
    
    <footer class="credit"><p>اعداد/المهندس خالد الغامدي</p></footer>
  </div>
  
  <div id="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAFIa5WAPy8Vn9p4T4Ak3yCly3_9bwsMZU", authDomain: "database-506.firebaseapp.com", projectId: "database-506", storageBucket: "database-506.firebasestorage.app", messagingSenderId: "926446561022", appId: "1:926446561022:web:9e57f6fd1fdc3a2f58a7af" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById('exam-form');
    const examCard = document.getElementById('exam-card');
    const successMessage = document.getElementById('success-message');
    const progressBar = document.getElementById('progress');
    const nameInput = document.getElementById('name');
    const idInput = document.getElementById('idNumber');
    const phoneInput = document.getElementById('phone');
    const emailInput = document.getElementById('email');
    
    let timerInterval = null;
    let TOTAL_STEPS = 3;
    let examConfig = {};

    function showToast(message, type = 'error') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    const updateProgress = (step) => {
      progressBar.parentElement.style.display = 'block';
      progressBar.style.width = `${((step - 1) / TOTAL_STEPS) * 100}%`;
    };

    const startTimer = (durationInSeconds, display, onTimeUp) => {
        clearInterval(timerInterval);
        let timer = durationInSeconds;
        timerInterval = setInterval(() => {
            let minutes = Math.floor(timer / 60).toString().padStart(2, '0');
            let seconds = (timer % 60).toString().padStart(2, '0');
            display.textContent = `${minutes}:${seconds}`;
            if (--timer < 0) {
                clearInterval(timerInterval);
                onTimeUp();
            }
        }, 1000);
    };

    const showStep = (stepNumber) => {
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      const stepToShow = document.querySelector(`.step[data-step="${stepNumber}"]`);
      if (stepToShow) {
        stepToShow.classList.add("active");
        updateProgress(stepNumber);
        if (examConfig.timerMode === 'individual' && stepNumber > 3) {
            const questionIndex = stepNumber - 4;
            const question = examConfig.questions[questionIndex];
            const timerSpan = stepToShow.querySelector('.timer-span');
            const onTimeUp = () => {
                stepToShow.querySelector('textarea').disabled = true;
                stepToShow.querySelector('button[data-next], button[type="submit"]').click();
            };
            startTimer(question.duration * 60, timerSpan, onTimeUp);
        } else if (examConfig.timerMode === 'total' && stepNumber === 4 && !timerInterval) {
            const totalTimerSpan = document.getElementById('total-timer-span');
            const onTimeUp = () => {
                form.querySelectorAll('textarea').forEach(ta => ta.disabled = true);
                submitExam(form.querySelector('button[type="submit"]'), examConfig.id);
            };
            startTimer(examConfig.totalDuration * 60, totalTimerSpan, onTimeUp);
        }
      }
    };
    
    const showError = (step, msg) => { if(document.getElementById(`err${step}`)) document.getElementById(`err${step}`).textContent = msg; };
    const clearError = (step) => { if(document.getElementById(`err${step}`)) document.getElementById(`err${step}`).textContent = ''; };
    const validateStep = (step) => {
      clearError(step);
      let valid = true;
      if (step === 1) { if (!/^[\u0600-\u06FF\s]+$/.test(nameInput.value.trim())) { showError(1, "الاسم مطلوب باللغة العربية"); valid = false; } }
      else if (step === 2) { if (!/^\d{10}$/.test(idInput.value.trim())) { showError(2, "رقم الهوية يجب أن يتكون من 10 أرقام"); valid = false; } }
      else if (step === 3) {
        if (!/^05\d{8}$/.test(phoneInput.value.trim())) { showError(3, "صيغة الجوال غير صحيحة (e.g., 0512345678)"); valid = false; }
        else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim())) { showError(3, "صيغة البريد الإلكتروني غير صحيحة"); valid = false; }
      }
      return valid;
    };
    
    const submitExam = async (submitButton, examId) => {
        clearInterval(timerInterval);
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="loader"></span> جاري الإرسال...';
        const answers = examConfig.questions.map((q, i) => {
            const textarea = document.getElementById(`answer-${i}`);
            const answerText = textarea ? textarea.value.trim() : "";
            const wordCount = answerText.split(/\s+/).filter(w => w.length > 0).length;
            return { question: q.text, answer: answerText, wordCount: wordCount };
        });
        const formData = {
            name: nameInput.value.trim(), idNumber: idInput.value.trim(), phone: phoneInput.value.trim(),
            email: emailInput.value.trim(), examId: examId, answers: answers, submissionTime: serverTimestamp()
        };
        try {
            await addDoc(collection(db, "Submissions"), formData);
            examCard.style.display = 'none';
            successMessage.style.display = 'block';
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("❌ حدث خطأ أثناء الإرسال. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.");
            submitButton.disabled = false;
            submitButton.textContent = "إرسال الإجابة النهائية";
        }
    };

    async function loadExam(examId) {
        const loadingDiv = document.getElementById('loading-exam');
        try {
            const docRef = doc(db, "Exams", examId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const examData = docSnap.data();
                if (!examData.isActive) { loadingDiv.innerHTML = '<h3 style="color:var(--error);">هذا الاختبار غير متاح حاليًا.</h3><p>يرجى مراجعة المشرف على الاختبار.</p>'; return; }
                examConfig = { id: examId, questions: examData.questions, timerMode: examData.timerMode || 'individual', totalDuration: examData.totalDuration || 0 };
                TOTAL_STEPS += examConfig.questions.length;
                document.getElementById('exam-title-display').textContent = examData.title;
                if (examConfig.timerMode === 'total') { document.getElementById('total-timer-container').style.display = 'block'; }

                examConfig.questions.forEach((q, i) => {
                    const stepNum = i + 4;
                    const isLast = (i === examConfig.questions.length - 1);
                    const isFirstQuestion = (i === 0);
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.dataset.step = stepNum;
                    
                    const individualTimerHTML = examConfig.timerMode === 'individual' ? `<div class="timer">الوقت المتبقي: <span class="timer-span">${String(q.duration).padStart(2,'0')}:00</span></div>` : '';
                    const prevButtonHTML = !isFirstQuestion 
                        ? `<button type="button" class="btn-prev" data-prev="${stepNum - 1}">السابق</button>`
                        : `<button type="button" class="btn-prev" data-prev="${stepNum - 1}">بيانات التواصل</button>`;
                    const nextButtonHTML = isLast 
                        ? '<button type="submit">إرسال الإجابة النهائية</button>' 
                        : `<button type="button" data-next="${stepNum + 1}">السؤال التالي</button>`;

                    stepDiv.innerHTML = `
                        <h3>السؤال ${i + 1} / ${examConfig.questions.length}</h3>
                        ${individualTimerHTML}
                        <p style="font-size: 1.1em; line-height: 1.7;">${q.text}</p>
                        <textarea id="answer-${i}" rows="10" placeholder="ابدأ الكتابة هنا..."></textarea>
                        <div class="counter-wrapper">
                            <div class="word-progress-bar"><div class="word-progress-bar-inner" id="wpb-${i}"></div></div>
                            <div class="counter-text">عدد الكلمات: <span id="wordCount-${i}">0</span> / ${q.wordCount}</div>
                        </div>
                        <div class="step-actions">${prevButtonHTML}${nextButtonHTML}</div>`;
                    form.appendChild(stepDiv);
                    
                    const textarea = stepDiv.querySelector(`#answer-${i}`);
                    const wordCountSpan = stepDiv.querySelector(`#wordCount-${i}`);
                    const wordProgressBar = stepDiv.querySelector(`#wpb-${i}`);
                    
                    let lastValidAnswer = textarea.value;
                    let lastInputTime = Date.now();
                    let charCountThisInterval = 0;
                    const RATE_LIMIT_CHARS = 10; // ✅ تم التغيير إلى 10
                    
                    textarea.addEventListener('input', () => {
                        const currentTime = Date.now();
                        const timeDiff = currentTime - lastInputTime;
                        const currentValue = textarea.value;
                        const charsAdded = currentValue.length - lastValidAnswer.length;

                        if (charsAdded > 0) {
                            if (timeDiff > 1000) { charCountThisInterval = 0; lastInputTime = currentTime; }
                            charCountThisInterval += charsAdded;
                            if (charCountThisInterval > RATE_LIMIT_CHARS) {
                                textarea.value = lastValidAnswer;
                                showToast('رصد محاولة غش: سرعة الكتابة عالية جدًا');
                            } else { lastValidAnswer = currentValue; }
                        } else { lastValidAnswer = currentValue; }
                        
                        const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                        wordCountSpan.textContent = words.length;
                        const progress = Math.min((words.length / q.wordCount) * 100, 100);
                        wordProgressBar.style.width = `${progress}%`;
                        wordProgressBar.classList.toggle('completed', progress >= 100);
                    });
                });
                loadingDiv.style.display = 'none';
                form.style.display = 'block';
                showStep(1);
            } else { loadingDiv.innerHTML = '<h3 style="color:var(--error);">خطأ: الاختبار المطلوب غير موجود.</h3><p>يرجى التأكد من صحة الرابط.</p>'; }
        } catch (error) { console.error("Error fetching exam:", error); loadingDiv.innerHTML = '<h3 style="color:var(--error);">حدث خطأ أثناء تحميل الاختبار.</h3><p>يرجى تحديث الصفحة.</p>'; }
    }

    form.addEventListener('paste', (e) => {
        if (e.target.tagName === 'TEXTAREA') {
            e.preventDefault();
            showToast('رصد محاولة غش: اللصق غير مسموح به.');
        }
    });

    form.addEventListener('click', (e) => {
        const nextBtn = e.target.closest('button[data-next]');
        const prevBtn = e.target.closest('button[data-prev]');
        if (nextBtn) { 
            const currentStep = parseInt(nextBtn.closest('.step').dataset.step);
            if (validateStep(currentStep)) { showStep(parseInt(nextBtn.dataset.next)); }
        }
        if (prevBtn) { showStep(parseInt(prevBtn.dataset.prev)); }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('id');
    form.addEventListener('submit', (e) => { e.preventDefault(); submitExam(e.target.querySelector('button[type="submit"]'), examId); });
    
    if (examId) { loadExam(examId); } 
    else { document.getElementById('loading-exam').innerHTML = '<h3 style="color:var(--error);">خطأ: رابط الاختبار غير مكتمل.</h3><p>يجب أن يحتوي الرابط على ID الاختبار للبدء.</p>'; }
  </script>
</body>
</html>
